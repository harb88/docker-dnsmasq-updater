# shellcheck shell=bash disable=SC2034

DEFAULT_PYTHON_VERSION='3.9'

SSL_LIBRARY='openssl'
HINTS_DIR="$(pwd)/hints"

WHEEL_REPO="moonbuggy2000/python-musl-wheels"

PYTHON_WHEELS="paramiko-${SSL_LIBRARY} python-hosts"

# Alpine has no cargo or rust packages for s390x
EXCLUDED_ARCHES='s390x'

declare -A BUILD_ARGS=( \
	[BUILD_PYTHON_VERSION]='Python version' \
	[DEBIAN_RELEASE]='Debian release' \
	[SSL_LIBRARY]='SSL library' \
	[IMPORTS_DIR]='Imports dir' \
	[HINTS_DIR]='Nuitka hints dir' \
)

declare -A CHECKOUT_DISPLAY=( \
	[BUILD_PYTHON_VERSION]='Python version' \
	[DOCKER_FILE]='Dockerfile' \
	[SSL_LIBRARY]='SSL library' \
)

env_end () {
	case "${DOCKER_TAG}" in
		*debian*|*buster*)
			TARGET_TAG='debian'
			SOURCE_REPO='moonbuggy2000/debian-slim-s6-python'
			DOCKER_FILE='Dockerfile.debian'
			ARCH_YAML='hooks/arch.debian.yaml'
			;;&
		debian-binary*|buster-binary*)
			TARGET_TAG='debian-binary'
			DOCKER_FILE='Dockerfile.binary'
			;;
		*alpine*|binary*|latest*|hints*)
			TARGET_TAG='alpine'
			SOURCE_REPO='moonbuggy2000/alpine-s6-python'
			unset DEBIAN_RELEASE
			unset ALPINE_VERSION
			ARCH_YAML='hooks/arch.alpine.yaml'
			;;&
		alpine-binary*|binary*|latest*)
			TARGET_TAG='alpine-binary'
			SOURCE_REPO='moonbuggy2000/alpine-s6'
			ALPINE_VERSION="3.15"
			DOCKER_FILE='Dockerfile.binary'
			;;
	esac

	[ -z "${SOURCE_REPO+set}" ] \
		&& echo "Can't build tag '${DOCKER_TAG}'." \
		&& exit 1
}

post_checkout_start () {
	add_param "${PYTHON_VERSION:-${DEFAULT_PYTHON_VERSION}}" 'BUILD_PYTHON_VERSION'

	case "${TARGET_TAG}" in
		alpine-binary) SOURCE_TAG="${ALPINE_VERSION}" ;;
		*) SOURCE_TAG="${BUILD_PYTHON_VERSION}" ;;
	esac
}

## extra tags to add during post_push
get_manifest_tags () {
	local extra_tags && extra_tags=()

	case "${TARGET_TAG}" in
		alpine) extra_tags+=('script') ;;
		alpine-binary) extra_tags+=('binary' 'latest') ;;
	esac

	echo "${extra_tags[@]}"
}
